# Telegram Archive Bot

## Описание

Telegram Archive Bot — это бот для Telegram, предназначенный для архивирования сообщений, медиафайлов, а также отслеживания изменений и удалений сообщений в бизнес-чатах. Бот сохраняет сообщения в базе данных SQLite, хранит медиафайлы на сервере и отправляет уведомления администратору о действиях, таких как редактирование, удаление сообщений или обнаружение спама. Проект включает защиту от спама, автоматическую очистку старых данных и резервное копирование базы данных.

## Возможности

- **Архивирование сообщений**: Сохранение текста, медиа (фото, видео, документы, голосовые и аудио сообщения) и метаданных сообщений.
- **Отслеживание изменений**: Регистрация редактирований и удалений сообщений с сохранением оригинального контента.
- **Защита от спама**: Ограничение отправки медиа при превышении лимита (например, слишком много фото за минуту).
- **Уведомления администратора**: Отправка уведомлений о редактировании, удалении или спаме в бизнес-чате.
- **Автоматическая очистка**: Удаление сообщений и медиа старше заданного периода (по умолчанию 5 дней).
- **Резервное копирование**: Ежедневное создание и отправка резервной копии базы данных администратору.
- **Команды администратора**:
  - `/stats`: Статистика по сообщениям (общее количество, удаленные, отредактированные, с медиа).
  - `/size`: Размер директории проекта.
- **Системный сервис**: Возможность настройки автозапуска бота через systemd.

## Требования

- **Операционная система**: Ubuntu (рекомендуется 20.04 или новее).
- **Python**: Версия 3.8 или выше.
- **Зависимости Python**: `requests`, `schedule` (устанавливаются автоматически).
- **Права root**: Для установки и настройки systemd сервиса.
- **Токен Telegram бота**: Получите токен через [BotFather](https://t.me/BotFather).
- **Бизнес-подключение Telegram**: Настройка бизнес-чата для работы бота.

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <repository-url>
   cd <repository-directory>
   ```

2. **Сделайте скрипт установки исполняемым**:
   ```bash
   chmod +x install.sh
   ```

3. **Запустите установку**:
   ```bash
   sudo ./install.sh
   ```

   Во время установки:
   - Укажите токен Telegram бота.
   - Настройте параметры (порог спама, максимальный размер файла, период очистки и т.д.).
   - Решите, запускать ли `init_bot.py` для настройки бизнес-подключения (рекомендуется выбрать "y").
   - Выберите, устанавливать ли systemd сервис для автозапуска (рекомендуется выбрать "y").

4. **Настройте бизнес-подключение** (если не сделали во время установки):
   ```bash
   cd /opt/telegram-bot
   python3 init_bot.py
   ```
   Следуйте инструкциям в консоли для подключения бота в Telegram.

## Использование

- Если установлен systemd сервис:
  - Проверьте статус: `sudo systemctl status telegram-bot`
  - Остановите/перезапустите: `sudo systemctl stop telegram-bot` или `sudo systemctl restart telegram-bot`
  - Логи: `journalctl -u telegram-bot`

- Если запуск вручную:
  ```bash
  cd /opt/telegram-bot
  python3 as.py
  ```

- **Директории и файлы**:
  - Медиафайлы: `/opt/telegram-bot/media_archive/`
  - База данных: `/opt/telegram-bot/messages.db`
  - Отслеживание спама: `/opt/telegram-bot/spam_tracker.json`
  - Конфигурация: `/opt/telegram-bot/config.py`

- **Команды администратора**:
  Отправьте в чат с ботом:
  - `/stats` — для получения статистики сообщений.
  - `/size` — для проверки размера директории проекта.

## Конфигурация

Файл `config.py` (генерируется скриптом установки) содержит следующие параметры:
- `TOKEN`: Токен Telegram бота.
- `ADMIN_ID`, `ALLOWED_BUSINESS_ID`, `SENDER_USERNAME`: Заполняются автоматически через `init_bot.py`.
- `MEDIA_DIR`: Директория для хранения медиа (по умолчанию `media_archive`).
- `MAX_FILE_SIZE`: Максимальный размер файла (по умолчанию 50 МБ).
- `CLEANUP_DAYS`: Период хранения сообщений (по умолчанию 5 дней).
- `SPAM_THRESHOLD`, `SPAM_WINDOW`, `SPAM_BLOCK_DURATION`: Параметры защиты от спама.

## Логирование

- Логи выводятся в консоль (при ручном запуске) или в systemd journal (`journalctl -u telegram-bot`).
- Уведомления о спаме, редактировании и удалении сообщений отправляются администратору через Telegram.

## Устранение неполадок

- **Бот не отвечает**: Проверьте токен в `config.py` и убедитесь, что бизнес-подключение активно.
- **Ошибки сети**: Бот автоматически пытается повторно подключиться при сбоях.
- **Проблемы с systemd**: Проверьте статус сервиса (`sudo systemctl status telegram-bot`) и логи (`journalctl -u telegram-bot`).
- **Большой размер директории**: Используйте команду `/size` и настройте `CLEANUP_DAYS` для более частой очистки.

## Лицензия

Проект распространяется под лицензией MIT. См. файл `LICENSE` для подробностей.

## Авторы

- **Eg_Rek**
  - Telegram: [t.me/eg_rek](https://t.me/eg_rek)
  - GitHub: [github.com/Eg-rek](https://github.com/Eg-rek)

## Контакты

Если у вас есть вопросы или предложения, свяжитесь через Telegram: [t.me/eg_rek](https://t.me/eg_rek).
